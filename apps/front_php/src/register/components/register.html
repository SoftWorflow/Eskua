<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrarse - Eskua</title>
    <link rel="stylesheet" href="../../output.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
    <!-- Google Register -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="flex justify-center items-center w-full min-h-screen bg-neutral-400 p-6">
    
    <div class="flex flex-row justify-center items-center bg-white w-full h-full min-h-[calc(100vh-48px)] rounded-3xl p-8 gap-20 max-w-[1920px]">
        
        <!-- Contenedor de datos -->
        <div class="max-w-[30rem] flex-1 flex flex-col justify-center text-center w-full">
            <h6 class="text-lg md:text-xl mb-4">Eskua</h6>

            <div class="my-4 mb-12">
                <h2 class="text-3xl md:text-4xl lg:text-5xl font-normal">Crear Una Cuenta</h2>
            </div>

            <div class="flex flex-col gap-9">
                <!-- Username -->
                <div class="flex items-center relative w-full min-h-[50px] max-h-20 leading-[50px]">
                    <div id="username-error-message" class="absolute text-red-500 text-sm -translate-y-11 z-50 whitespace-nowrap select-none"></div>
                    <input
                        type="text"
                        name="username"
                        id="username"
                        required
                        class="absolute w-full outline-none text-xl md:text-2xl px-3.5 leading-[50px] h-[50px] rounded-xl bg-transparent border-2 border-gray-200 transition-all duration-100 z-10"
                    />
                    <label 
                        for="username" 
                        class="absolute text-xl md:text-2xl px-3.5 mx-5 transition-all duration-200 bg-white select-none pointer-events-none"
                    >
                        Nombre Usuario
                    </label>
                </div>

                <!-- Email -->
                <div class="flex items-center relative w-full min-h-[50px] max-h-20 leading-[50px]">
                    <div id="email-error-message" class="absolute text-red-500 text-sm -translate-y-11 z-50 whitespace-nowrap select-none"></div>
                    <input
                        type="email"
                        name="email"
                        id="user-email"
                        required
                        class="absolute w-full outline-none text-xl md:text-2xl px-3.5 leading-[50px] h-[50px] rounded-xl bg-transparent border-2 border-gray-200 transition-all duration-100 z-10"
                    />
                    <label 
                        for="user-email" 
                        class="absolute text-xl md:text-2xl px-3.5 mx-5 transition-all duration-200 bg-white select-none pointer-events-none"
                    >
                        Email
                    </label>
                </div>

                <!-- Password -->
                <div class="flex items-center relative w-full min-h-[50px] max-h-20 leading-[50px]">
                    <div id="password-error-message" class="absolute text-red-500 text-sm -translate-y-11 z-50 whitespace-nowrap select-none"></div>
                    <input
                        type="password"
                        name="password"
                        id="user-password"
                        required
                        class="absolute w-full outline-none text-xl md:text-2xl px-3.5 pr-16 leading-[50px] h-[50px] rounded-xl bg-transparent border-2 border-gray-200 transition-all duration-100 z-10"
                    />
                    <label 
                        for="user-password" 
                        class="absolute text-xl md:text-2xl px-3.5 mx-5 transition-all duration-200 bg-white select-none pointer-events-none"
                    >
                        Contraseña
                    </label>
                    <img src="../images/show.png" id="eye-icon" class="absolute right-5 w-8 cursor-pointer z-[70]" onclick="HandleShowingAndHidingPassword()">
                </div>

                <!-- Verify Password -->
                <div class="flex items-center relative w-full min-h-[50px] max-h-20 leading-[50px]">
                    <div id="verify-password-error-message" class="absolute text-red-500 text-sm -translate-y-11 z-50 whitespace-nowrap select-none"></div>
                    <input
                        type="password"
                        name="verify-password"
                        id="verify-user-password"
                        required
                        class="absolute w-full outline-none text-xl md:text-2xl px-3.5 pr-16 leading-[50px] h-[50px] rounded-xl bg-transparent border-2 border-gray-200 transition-all duration-100 z-10"
                    />
                    <label 
                        for="verify-user-password" 
                        class="absolute text-xl md:text-2xl px-3.5 mx-5 transition-all duration-200 bg-white select-none pointer-events-none"
                    >
                        Confirmar Contraseña
                    </label>
                    <img src="../images/show.png" id="eye-icon-verify" class="absolute right-5 w-8 cursor-pointer z-[70]" onclick="HandleShowingAndHidingVerifyPassword()">
                </div>

                <button 
                    type="button"
                    id="register-btn"
                    class="h-12 text-lg md:text-xl leading-6 w-full border-none rounded-xl bg-gray-200 cursor-pointer hover:bg-gray-300 transition-colors"
                >
                    Registrarse
                </button>
            </div>

            <div class="flex flex-row gap-5 w-full justify-center my-7 items-center">
                <span class="text-gray-400">───────────</span>
                <p class="text-sm md:text-base">O registrarse con</p>
                <span class="text-gray-400">───────────</span>
            </div>

            <div class="flex flex-row justify-center w-full gap-5">
                <button 
                    type="button"
                    id="google-btn"
                    class="h-12 text-lg md:text-xl leading-6 w-full border-none rounded-xl bg-gray-200 cursor-pointer hover:bg-gray-300 transition-colors"
                >
                    Google
                </button>
            </div>

            <div class="flex justify-center flex-row items-end mt-5 gap-1.5">
                <p class="text-sm md:text-base">Ya tienes una cuenta?</p>
                <a href="../login/" class="text-blue-900 text-sm md:text-base hover:underline">
                    Iniciar Sesión
                </a>
            </div>
        </div>

        <!-- Contenedor de imagen - Solo visible en pantallas grandes -->
        <div class="hidden xl:block w-1/2 min-w-[50rem] h-full bg-gray-300 rounded-3xl"></div>
    </div>

    <script>
        let isUsernameValid;
        let isEmailValid;
        let isPasswordValid;
        let isSamePassword;

        window.addEventListener('DOMContentLoaded', StartEvents);

        function StartEvents() {
            AddListeners();
            Google();
        }

        function Google() {
            google.accounts.id.initialize({
                client_id: "761002639560-vejkjfodd513khe9ifmrsjq46o0c619s.apps.googleusercontent.com",
                callback: handleCredentialResponse,
            });

            google.accounts.id.prompt();

            const button = document.getElementById('google-btn');
            button.addEventListener('click', () => {
                google.accounts.id.prompt();
            });
        }

        function handleCredentialResponse(response) {
            console.log("Token:", response.credential);
        }

        function AddListeners() {
            const usernameField = document.getElementById('username');
            usernameField.addEventListener('blur', CheckUsername);
            usernameField.addEventListener('input', UpdateLabelState);

            const emailField = document.getElementById('user-email');
            emailField.addEventListener('blur', CheckEmail);
            emailField.addEventListener('input', UpdateLabelState);

            const passwordField = document.getElementById('user-password');
            passwordField.addEventListener('blur', CheckPassword);
            passwordField.addEventListener('change', VerifySecondTimePassword);
            passwordField.addEventListener('input', UpdateLabelState);

            const verifyPasswordField = document.getElementById('verify-user-password');
            verifyPasswordField.addEventListener('blur', VerifySecondTimePassword);
            verifyPasswordField.addEventListener('change', VerifySecondTimePassword);
            verifyPasswordField.addEventListener('input', UpdateLabelState);

            const registerBtn = document.getElementById('register-btn');
            registerBtn.addEventListener('click', SendRegisterData);
        }

        function UpdateLabelState(e) {
            const input = e.target;
            const label = input.nextElementSibling;
            
            if (input.value !== '') {
                label.classList.add('h-7', 'leading-7', 'z-20', '-translate-x-3.5', '-translate-y-6', 'scale-90');
            } else {
                label.classList.remove('h-7', 'leading-7', 'z-20', '-translate-x-3.5', '-translate-y-6', 'scale-90');
            }
        }

        function HandleShowingAndHidingPassword() {
            const password = document.getElementById('user-password');
            const eyeIcon = document.getElementById('eye-icon');
            HidingAndShowingHandler(password, eyeIcon);
        }

        function HandleShowingAndHidingVerifyPassword() {
            const verifyPassword = document.getElementById('verify-user-password');
            const eyeIcon = document.getElementById('eye-icon-verify');
            HidingAndShowingHandler(verifyPassword, eyeIcon);
        }

        function HidingAndShowingHandler(password, eyeIcon) {
            if (password.type === 'password') {
                password.type = 'text';
                eyeIcon.src = '../images/hide.png';
            } else {
                password.type = 'password';
                eyeIcon.src = '../images/show.png';
            }
        }

        function SendRegisterData() {
            if (isUsernameValid && isEmailValid && isPasswordValid) {
                if (isSamePassword) {
                    const usernameField = document.getElementById('username');
                    const emailField = document.getElementById('user-email');
                    const passwordField = document.getElementById('user-password');

                    const data = {
                        username: usernameField.value,
                        email: emailField.value,
                        password: passwordField.value,
                    };

                    fetch('register.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    }).then(res => res.json()).then(res => {
                        console.log('Registro exitoso', res);
                    })
                    .catch(err => console.error(err));
                }
            }
        }

        function CheckUsername(e) {
            const usernameField = document.getElementById('username');
            const errMsgElement = document.getElementById('username-error-message');
            const label = usernameField.nextElementSibling;
            const username = e.target.value; 
            let message = '';
            
            const regex = /^[A-Za-z.]+$/;
            isUsernameValid = regex.test(username);

            if (username.length === 0) {
                message = 'El nombre de usuario es obligatorio';
            } else if (username.length > 30) {
                isUsernameValid = false; 
                message = 'Nombre de usuario muy largo (30 máx.)';
            } else if (/\d/.test(username)) {
                message = 'No puede contener números';
            } else if (/[^A-Za-z.]/.test(username)) {
                message = 'No puede contener caracteres especiales ni espacios';
            }

            ToggleValidationState(isUsernameValid, usernameField, label);
            errMsgElement.innerHTML = message;
        }

        function CheckEmail(e) {
            const emailField = document.getElementById('user-email');
            const emailErrorMessage = document.getElementById('email-error-message');
            const label = emailField.nextElementSibling;
            const email = e.target.value;

            const regex = /^[A-Za-z0-9._%+-]+@(?:[A-Za-z0-9-]+\.)+[A-Za-z]{2,}$/;
            isEmailValid = regex.test(email);

            if (email.length > 320) {
                isEmailValid = false;
                emailErrorMessage.innerHTML = 'El correo es muy largo (320 máx.)';
            } else if (!isEmailValid) {
                emailErrorMessage.innerHTML = 'Ingrese un correo válido';
            } else {
                emailErrorMessage.innerHTML = '';
            }

            ToggleValidationState(isEmailValid, emailField, label);
        }

        function CheckPassword(e) {
            const passwordField = document.getElementById('user-password');
            const passwordErrorMessage = document.getElementById('password-error-message');
            const label = passwordField.nextElementSibling;
            const password = e.target.value;

            const regex = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d).{8,}$/;
            isPasswordValid = regex.test(password);

            if (!/^(?=.*[a-z])(?=.*[A-Z]).+$/.test(password)) {
                passwordErrorMessage.innerHTML = 'La contraseña debe contener mayúsculas y minúsculas';
            } else if (!/^(?=.*\d).+$/.test(password)) {
                passwordErrorMessage.innerHTML = 'La contraseña debe incluir al menos un número';
            } else if (password.length < 8) {
                passwordErrorMessage.innerHTML = 'La contraseña es demasiado corta (8 caracteres mín.)';
            } else {
                passwordErrorMessage.innerHTML = ''
            }

            ToggleValidationState(isPasswordValid, passwordField, label);
        }

        function VerifySecondTimePassword() {
            const passwordField = document.getElementById('user-password');
            const verifyPasswordField = document.getElementById('verify-user-password');
            const verifyPasswordErrorMessage = document.getElementById('verify-password-error-message');
            const label = verifyPasswordField.nextElementSibling;

            const isVerifyPasswordOk = verifyPasswordField.value !== '' && verifyPasswordField.value === passwordField.value;

            if (!isVerifyPasswordOk){
                verifyPasswordErrorMessage.innerHTML = 'Las contraseñas no coinciden';
            } else {
                verifyPasswordErrorMessage.innerHTML = '';
            }

            ToggleValidationState(isVerifyPasswordOk, verifyPasswordField, label);
            isSamePassword = isVerifyPasswordOk;
        }

        function ToggleValidationState(valid, field, label) {
            // Asegurar que el label esté animado cuando hay contenido
            if (field.value !== '') {
                label.classList.add('h-7', 'leading-7', 'z-20', '-translate-x-3.5', '-translate-y-6', 'scale-90');
            }

            if (!valid) {
                // Estado inválido
                field.classList.remove('border-gray-200', 'border-green-500', 'text-green-500');
                field.classList.add('border-red-500', 'text-red-500');
                label.classList.remove('text-green-500');
                label.classList.add('text-red-500');
            } else {
                // Estado válido
                field.classList.remove('border-gray-200', 'border-red-500', 'text-red-500');
                field.classList.add('border-green-500', 'text-green-500');
                label.classList.remove('text-red-500');
                label.classList.add('text-green-500');
            }
        }
    </script>

</body>
</html>